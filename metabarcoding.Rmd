---
title: 'Metabarcoding - AB332'
output: html_notebook
---

# Metabarcoding Script

```{r}
# Main Wrangling Packages includes ggplot
library(tidyverse)
library(lubridate)
library(glue)
# Helper Packages
library(here)
# Vegan for Indixes and zCompositions for normalizing
library(vegan)
library(zCompositions)
# Plot Helper
library(ggforce)
library(patchwork)

source("functions/functions.R")
```

## Data Informations

The data is 3 year from the Isa time series (2011-2014) processed through USearch with clustering at 99%,
arbitrarily removing any OTU with less than 50 reads in the total dataset and removing OTUs assigned to Streptophyta, Metazoa and Fungi.
Rarefied to 5398 reads per sample. Taxonomic assignment with PR2 using blast. Only DNA from 25m is included.

## Loading data

```{r}
data_meta <- readr::read_tsv("data/AB332metadata_v3.txt") %>%
    glimpse()
data_taxa <- readr::read_tsv("data/AB332_2021_taxtab.txt") %>%
    glimpse()
data_otu <- readr::read_tsv("data/AB332_otutab_reduc3.txt") %>%
    column_to_rownames(var = "OTUNumber") %>%
    # for vegan package
    t()
```

## Normalize counts

We have different sample reads:

```{r}
rarecurve(data_otu, step = 100, xlab = "Number of reads", ylab = "Richness", col = "blue")
```

This is to make our reads comparable between sample dates. We could use the standard rarefaction method, because our MALV will not be lost as they are in higher abundance.

```{r}
minimum_reads <- min(rowSums(data_otu))
data_otu_raref <- rrarefy(data_otu, minimum_reads)
data_otu_raref <- data_otu_raref[, -(which(colSums(data_otu_raref) == 0))]
```

## Impute Missing values

```{r}
library(imputeTS)
data_meta <- data_meta %>%
    mutate(
        season_nr = as_factor(season_nr),
        watermass = as_factor(watermass),
        data = lubridate::as_date(date)
    ) %>%
    mutate(
        across(where(is.numeric), imputeTS::na_interpolation, option = "spline")
    ) %>%
    glimpse()
```

## Data wrangling

Generating a nice tibble which contains all the information and the normalized counts.

```{r}
data_df <- as_tibble(data_otu_raref, rownames = NA) %>%
    rownames_to_column(var = "Sample_Name") %>%
    pivot_longer(-Sample_Name, names_to = "OTUname") %>%
    left_join(data_taxa, by = c("OTUname")) %>%
    left_join(data_meta %>% dplyr::select(-date), by = c("Sample_Name")) %>%
    glimpse()

data_df <- data_df %>%
    separate(Sample_Name, into = c("Station", "Date"), sep = "_", remove = FALSE) %>%
    mutate(
        date = lubridate::as_date(Date)
    ) %>%
    glimpse()
```

## Exploration

We are only interested in Phylum? As this is were MALVs are in this dataset.

```{r}
data_grouped <- data_df %>%
    filter(value != 0) %>%
    group_by(Sample_Name, date, Phylum) %>%
    summarise(
        watermass = first(watermass),
        seasons = first(seasons),
        value = sum(value),
        .groups = "drop"
    ) %>%
    glimpse()
```

Generate relative counts and group everything under 5% relative abundance for better visibility except for our MALVs.

```{r}
data_filtered <- data_grouped %>%
    group_by(Sample_Name) %>%
    mutate(value_sum = sum(value)) %>%
    ungroup() %>%
    mutate(value_p = value / value_sum) %>%
    filter(value != 0) %>%
    mutate(
        label = case_when(
            Phylum == "MALVs" ~ Phylum,
            value_p >= 0.05 ~ ifelse(is.na(Phylum), "Unknown", Phylum),
            TRUE ~ "< 5%"
        ),
        seasons = stringr::str_to_title(seasons)
    ) %>%
    glimpse()
```

Plotting the total composition:
```{r}
# Custom Colors for MALVs
n <- unique(data_filtered$label)
color_values <- scales::hue_pal()(length(n))
names(color_values) <- n
color_values["MALVs"] <- "black"
color_values["< 5%"] <- "gray50"
color_values["Unknown"] <- "gray70"

color_values <- color_values[stringr::str_order(names(color_values))]
# Custom Axis Colors
color_seasons <- c("Winter" = "#0072B2", "Spring" = "#E69F00", "Summer" = "#D55E00", "Autumn" = "#009E73")

data_filtered <- data_filtered %>%
    mutate(
        label = forcats::fct_relevel(label, "< 5%", "Unknown", after = 0L),
        label = forcats::fct_relevel(label, "MALVs", after = Inf)
    )

p <- data_filtered %>%
    mutate(
        year = year(date),
        year = ifelse(year %in% c("2011", "2012"), "2011-2012", year),
    ) %>%
    ggplot(aes(x = as.character(date), y = value_p, fill = label)) +
    geom_col(width = 1) +
    geom_text(
        aes(y = 1, label = watermass, color = seasons),
        check_overlap = TRUE,
        nudge_y = 0.1,
        show.legend = FALSE
    ) +
    geom_text(
        aes(y = 1, label = substring(seasons, 1, 2), color = seasons),
        check_overlap = TRUE,
        nudge_y = 0.15,
        show.legend = FALSE
    ) +
    # ggplot2::annotate(
    #     "text",
    #     y = 1.1,
    #     x = 0,
    #     label = "WM:"
    # ) +
    # scale_x_date(
    #    date_breaks = "1 month",
    #    date_labels = "%m"
    # ) +
    ggplot2::coord_cartesian(clip = FALSE) +
    scale_x_discrete(
        label = ~ substring(.x, first = 6)
    ) +
    scale_fill_manual(
        values = color_values
    ) +
    scale_color_manual(
        values = color_seasons
    ) +
    scale_y_continuous(
        breaks = scales::pretty_breaks(),
        label = scales::label_percent()
    ) +
    facet_wrap(~year, scales = "free_x", ncol = 1) +
    labs(
        y = "Relative abundance [%]",
        x = "Month",
        fill = "Phylum"
    ) +
    theme(
        legend.position = "right",
        axis.text.x = element_text(
            angle = 40,
            hjust = 1,
            size = 8
        )
    )
fSaveImages(p, "abundance", h = 18, w = 13)
```

### MALVs Detail
```{r}
data_malvs <- data_filtered %>%
    filter(label == "MALVs") %>%
    add_count(seasons, name = "seasons_n") %>%
    add_count(watermass, name = "watermass_n") %>%
    glimpse()
```

Types of MALVs
```{r}
data_malvs_tax <- data_df %>%
    filter(value != 0 & Phylum == "MALVs") %>%
    group_by(data) %>%
    mutate(value_sum = sum(value)) %>%
    ungroup() %>%
    group_by(date, Tax1) %>%
    summarise(
        seasons = first(seasons) %>% stringr::str_to_title(),
        value_p = sum(value) / first(value_sum),
        Tax1 = stringr::str_replace_all(first(Tax1), "_", " ") %>% stringr::str_remove_all("group")
    ) %>%
    glimpse()

p <- data_malvs_tax %>%
    ggplot(aes(x = as.character(date), y = value_p, fill = Tax1)) +
    geom_col(color = "black") +
    geom_text(
        aes(y = 1, label = substring(seasons, 1, 2), color = seasons),
        check_overlap = FALSE,
        nudge_y = 0.1,
        show.legend = FALSE,
        size = 1.5
    ) +
    scale_fill_manual(
        values = colorBlindBlack8,
    ) +
    scale_y_continuous(
        breaks = scales::pretty_breaks(),
        labels = scales::label_percent()
    ) +
    scale_x_discrete(
        # label = ~ substring(.x, first = 6)
    ) +
    labs(
        y = "Relative Abundance MALV [%]",
        x = "Dates",
        fill = "Taxa"
    ) +
    theme(
        legend.position = "bottom",
        axis.text.x = element_text(angle = 40, hjust = 1, size = 5)
    )

fSaveImages(p, "malvs_taxa", w = 10)
```

```{r}
p1 <- data_malvs %>%
    dplyr::mutate(
        seasons = forcats::fct_relevel(seasons, "Winter", "Spring", "Summer", "Autumn")
    ) %>%
    ggplot(aes(x = seasons, y = value_p, label = glue("n = {seasons_n}"))) +
    ggforce::geom_sina(
        show.legend = FALSE,
        color = colorBlindBlack8[1],
        alpha = 0.5,
        scale = "count"
    ) +
    geom_boxplot(aes(color = seasons), outlier.alpha = 0, show.legend = FALSE, alpha = 0) +
    stat_summary(
        fun = mean, geom = "point", show.legend = FALSE, color = colorBlindBlack8[[8]], shape = 18, size = 4
    ) +
    geom_text(aes(y = 0.45), check_overlap = TRUE) +
    labs(
        y = "Relative abundance [%]",
        x = "Seasons",
    ) +
    scale_color_manual(
        values = color_seasons
    ) +
    scale_y_continuous(
        breaks = scales::pretty_breaks(),
        label = scales::label_percent(accuracy = 1)
    ) +
    theme(
        panel.grid.major.y = element_line()
    )

p2 <- data_malvs %>%
    drop_na(watermass) %>%
    ggplot(aes(x = as.character(watermass), y = value_p, label = glue("n = {watermass_n}"))) +
    ggforce::geom_sina(
        aes(color = seasons),
        show.legend = FALSE,
        alpha = 0.5,
        scale = "count"
    ) +
    geom_boxplot(outlier.alpha = 0, show.legend = F, alpha = 0) +
    stat_summary(
        fun = mean, geom = "point", show.legend = F, color = colorBlindBlack8[[8]], shape = 18, size = 4
    ) +
    geom_text(aes(y = 0.45), check_overlap = TRUE) +
    scale_color_manual(
        values = color_seasons
    ) +
    labs(
        x = "Water masses",
        y = ""
    ) +
    scale_y_continuous(
        breaks = scales::pretty_breaks(),
        label = scales::label_percent(accuracy = 1)
    ) +
    theme(
        panel.grid.major.y = element_line()
    )

fSaveImages(p1 + p2 + patchwork::plot_annotation(tag_levels = "A"), "malv_season_watermasses", w = 10)
```

